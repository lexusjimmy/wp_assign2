<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Facebook Friends Lists</title>
		<link rel="stylesheet" type="text/css" href="CSS/FriendLists.css"/>
		<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
</head>

<body>
<div id="fb-root"></div>
		<script type="text/javascript" src="http://connect.facebook.net/en_US/all.js"></script>
		<script>
			var defaultPath = "http://lexusjimmy.github.io/wp_assign2/test.html";
			var uid;
			var Access_Token;
			var GroupID = new Array;
			var GroupMember = new Array;
			
			window.fbAsyncInit = function() {
				FB.init({
					appId: "173774022789425", // Your facebook app id
					status: true,
					cookie: true,
					xfbml: true
				});
			}
			
			(function(d, s, id) {
 			var js, fjs = d.getElementsByTagName(s)[0];
 			if (d.getElementById(id)) return;
 			js = d.createElement(s); js.id = id;
			js.src = "//connect.facebook.net/zh_TW/all.js#xfbml=1&appId=173774022789425";
 			fjs.parentNode.insertBefore(js, fjs);
			}(document, 'script', 'facebook-jssdk'));
		</script>
		<script>
			$(window).load(function () {
 				FB.login( loginDialog, { scope: 'read_friendlists, manage_friendlists, friends_birthday, friends_location'});//We only need the basic information
			});
			
			//Login or authentication may be failed, so checking the user's status is recommended.
			function loginDialog(){
				
				FB.getLoginStatus(function(response) {
					if (response.status === 'connected') {
					
						uid = response.authResponse.userID;
						Access_Token = response.authResponse.accessToken;
						//authResponse returns the list such as below
						//If you store these informations, you can further use them to promote your website
						/* the form returned
						{
							status: 'connected',
							authResponse: {
								accessToken: '...',
								expiresIn:'...',
								signedRequest:'...',
								userID:'...'
							}
						}
						*/
	
						listFriends();//Check that if the user is connected with the facebook. If yes, call the next function.
					} else if (response.status === 'not_authorized') {
					// the user is logged in to Facebook, but not connected to the app
						alert("To make this app execute, please authorize this app!");
						window.location = defaultPath;
					} else {
					// the user isn't even logged in to Facebook.
						alert("Login with your Facebook account!");
						window.location = defaultPath;
					}
				});
			}
			
			function listFriends(){
				
				//from now on we can decorate our website with the data related to the facebook.
				//list all your friends.
				FB.api('/me/friends', function(response){
				
					var i=0;
					
					while(response['data'][i] != null){
					
						var fId = response['data'][i]['id'];
						var fName = response['data'][i]['name'];
						$("<div onclick='changeInfo("+fId+");'><img src='https://graph.facebook.com/"+ fId + "/picture' /><span>"+fName+"</span></div>").appendTo("#FriendList");

						i++;
					}
				});
				
				//List all your friend lists
				FB.api('/me/friendlists', function(res){
					getFr(res);
				});
					
			}
			
			function getFr(temp){
				//use this to record the list number.
				var i = 0;
				
				//create the div of the list and add all of the list into the right area.
				while (temp["data"][i] != null){
					GroupID[i] = temp["data"][i]["id"];//Save the id value of the group into an array.
					
					$("<div><h1>" + temp["data"][i]["name"] + "</h1><ul class='sortFB connectSort' id='"+ GroupID[i] +"'></ul></div>").appendTo("#GroupList");
				
					i++;
				}
					
				var i = 0;
				
				getMembers(i);//start to display the existent members in the existent lists.
				
			}	
			
			function getMembers(num){
				
				//request the meber list, then call the insert function
				if(GroupID[num] != null){
				
					FB.api('/'+GroupID[num]+'/members', function(res){
						GroupMember[num] = res;
						listMember(num);
					});
				}
			}
			
			function listMember(num){
				var a = 0;
				
				//You have saved the responsed JSON into the array GroupMember, thus you can start to use this array to insert data. 
				while(GroupMember[num]["data"][a] != null){
							
					$("<div onclick='changeInfo("+GroupMember[num]["data"][a]["id"]+");'><img src='https://graph.facebook.com/"+ GroupMember[num]["data"][a]["id"] + "/picture' /><span>"+GroupMember[num]["data"][a]["name"]+"</span></div>").appendTo("#"+GroupID[num]);
						
					a++;
				}
				
				
				
				
				getMembers(num+1);
				
			}
			
			function changeInfo(friends){
				
				FB.api("/"+friends, function(response) {
					
					$("#name").text(response.name);
					$("#gender").text(response.gender);
					$("#birth").text(response.birthday);
					$("#loca").text(response.location.name);
					
				});
				
			}
		</script>
			<div id="FriendList" class="connectSort">
			</div>
			<div id="infoDiv">
				<ul id="ControlList">
					
				</ul>
				<div id="friendsInfo">
					<span>姓名：</span><span id="name"></span><br/>
					<span>性別：</span><span id="gender"></span><br/>
					<span>生日：</span><span id="birth"></span><br/>
					<span>住處：</span><span id="loca"></span><br/>
				</div>
			</div>
			<div id="GroupList" class="sortGroup sortGroup">
			</div>
</body>
</html>
